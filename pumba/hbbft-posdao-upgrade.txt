# Generate config data

./setup_testnet.py 1

# Generate Chain Spec

## Prepare network-spec

Insert the following two environment variables
* PUBLIC_KEYS
* IP_ADDRESSES

Where the `PUBLIC_KEYS` can be taken from the keys in the `hbbft_validator_ip_addresses` argument in the node.toml file.
Important: split the H512 into two H256 hex values.
TODO: Output public keys automatically in the hbbft config generator.

IP_ADDRESSES are not used at this point, just fill them with 1, in a 16 byte hex string.
The IP addresses are supplied using a Parity `reserved-peers` file.

Example:
```
PUBLIC_KEYS=0x130e7f5362067e559b59556295852c4ced854797f620a4f268033f3c872238f0,0xb941b4fd27eee924861f85c1354a54ad4ff89dd8bc37a241c0b93a0d59504a36
IP_ADDRESSES=0x11111111111111111111111111111111
```

## Prepare make_spec_hbbft.js

We need to supply arguments to the KeyGenHistory contract with `Parts` and `Acks` for each validator address like so:
```
  deploy = await contract.deploy({data: '0x' + contractsCompiled['KeyGenHistory'].bytecode, arguments: [
      ['0x42f860c1df760b1f16777f6142889e6f7709b969'],
      [[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,175,6,130,155,198,39,179,26,83,81,5,232,249,211,247,118,102,151,8,25,144,96,26,200,77,148,174,147,5,8,179,221,213,25,147,8,144,88,22,232,142,100,50,24,255,196,239,231,1,0,0,0,0,0,0,0,153,0,0,0,0,0,0,0,4,110,84,15,179,66,51,66,22,106,6,137,240,88,25,24,61,210,27,68,117,27,72,163,162,43,58,23,88,106,216,255,164,230,164,96,179,3,244,236,211,6,187,213,181,154,148,64,30,140,68,83,182,62,162,146,141,105,67,0,200,166,37,8,79,133,170,83,103,234,36,43,196,142,180,33,254,63,233,140,153,0,85,196,153,210,156,244,254,143,163,157,231,30,133,234,151,5,136,218,85,176,232,156,87,24,207,205,236,105,31,10,41,75,78,224,43,129,133,137,27,75,89,36,40,42,79,112,179,4,231,63,204,93,12,43,147,122,243,212,153,186,153,160,103,102,69,160,28,73,127,10,79]],
      [[[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,145,0,0,0,0,0,0,0,4,3,118,203,44,137,37,209,129,6,67,43,148,36,57,40,95,166,184,242,61,99,170,50,90,100,186,230,20,28,193,50,246,202,153,172,146,148,88,129,139,120,202,190,199,227,51,192,208,184,59,224,66,181,254,251,52,238,14,55,74,59,107,193,252,199,109,173,76,93,251,154,180,135,210,220,233,54,146,180,117,223,178,64,153,118,213,214,93,161,58,45,100,17,18,230,154,191,49,52,15,58,172,167,68,26,93,42,77,139,172,87,117,17,223,39,118,202,245,38,250,38,206,130,69,255,164,248,119,92,60,208,209,168,99,231,42,40,58,116,181,218,253,220,11]]]
    ]});
```

The hbbft config generator generates a file called `keygen_history.json`, which is formatted like:
```

{"parts":{"0x42f860c1df760b1f16777f6142889e6f7709b969":[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,175,6,130,155,198,39,179,26,83,81,5,232,249,211,247,118,102,151,8,25,144,96,26,200,77,148,174,147,5,8,179,221,213,25,147,8,144,88,22,232,142,100,50,24,255,196,239,231,1,0,0,0,0,0,0,0,153,0,0,0,0,0,0,0,4,110,84,15,179,66,51,66,22,106,6,137,240,88,25,24,61,210,27,68,117,27,72,163,162,43,58,23,88,106,216,255,164,230,164,96,179,3,244,236,211,6,187,213,181,154,148,64,30,140,68,83,182,62,162,146,141,105,67,0,200,166,37,8,79,133,170,83,103,234,36,43,196,142,180,33,254,63,233,140,153,0,85,196,153,210,156,244,254,143,163,157,231,30,133,234,151,5,136,218,85,176,232,156,87,24,207,205,236,105,31,10,41,75,78,224,43,129,133,137,27,75,89,36,40,42,79,112,179,4,231,63,204,93,12,43,147,122,243,212,153,186,153,160,103,102,69,160,28,73,127,10,79]},
 "acks": {"0x42f860c1df760b1f16777f6142889e6f7709b969":[[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,145,0,0,0,0,0,0,0,4,3,118,203,44,137,37,209,129,6,67,43,148,36,57,40,95,166,184,242,61,99,170,50,90,100,186,230,20,28,193,50,246,202,153,172,146,148,88,129,139,120,202,190,199,227,51,192,208,184,59,224,66,181,254,251,52,238,14,55,74,59,107,193,252,199,109,173,76,93,251,154,180,135,210,220,233,54,146,180,117,223,178,64,153,118,213,214,93,161,58,45,100,17,18,230,154,191,49,52,15,58,172,167,68,26,93,42,77,139,172,87,117,17,223,39,118,202,245,38,250,38,206,130,69,255,164,248,119,92,60,208,209,168,99,231,42,40,58,116,181,218,253,220,11]]}}
```

## Build chain spec

```
source network-spec
node scripts/make_spec_hbbft.js
```

Add the following two accounts for testing:
```
    "0x32e4e4c7c5d1cea5db5f9202a9e4d99e56c91a24": { 
      "balance": "1606938044258990275541962092341162602522202993782792835301376", 
      "nonce": "1048576" 
    },
    "0x0102ac5315c1bd986a1da4f1fe1b4bca36fa4667": { 
      "balance": "1606938044258990275541962092341162602522202993782792835301376", 
      "nonce": "1048576" 
    },
```

Copy the resulting `spec_hbbft.json` to the validator and rpc nodes folders and replace their `spec.json` file.

## Adjust reserved-peers

If the nodes are not running on a local machine adjust reserved-peers for the ip addresses and ports used.
Also adjust ports in node.toml files as necessary.